{"version":3,"sources":["../../src/core/dragndrop.js"],"names":["css","array","tree","dragndrop","selection","model","cb","draggable","droppable","guard","target","event","inputs","dataTransfer","types","length","selfDrop","contains","childDrop","ancestors","reduce","prev","curr","drop","updatedModel","category","filter","indexOf","e","adjustedTarget","Array","last","pluck","backup","drag","item","bak","JSON","stringify","setData","setTimeout","cancel","parse","paste","data","getData","utils","filesystem","items","kind","files","i","webkitGetAsEntry","getAsFile","push","nodeEvents","onDragStart","stopPropagation","get","onDrag","onDragOver","preventDefault","dropEffect","addClass","currentTarget","mixCss","onDragEnter","hasChildren","isAsync","hasClass","newVal","state","unfolded","set","onDragLeave","removeClass","onDrop","onDragEnd","onCancel","wrapEvents","onSelect","neighbours","outputs"],"mappings":"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","file":"dragndrop.js","sourcesContent":["// @flow\n\nimport { css, array, tree } from \"../tools\"\n\n// Drag and drop presets //\n\nexport const dragndrop = {\n    // Moves the selection //\n    selection: (model: void => Object[], cb: Object[] => void) => ({\n        draggable: true,\n        droppable: true,\n        guard: (target: ?Object, event: DragEvent, inputs: Object) => {\n            // Other data types\n            if(event && event.dataTransfer && event.dataTransfer.types.length > 0)\n                return false\n            // Prevent drop on self\n            const selfDrop = () => target && array(inputs.selection).contains(target)\n            // Prevent drop on child\n            const childDrop = () => inputs.ancestors &&\n                    inputs.ancestors.reduce((prev, curr) =>\n                        prev || array(inputs.selection).contains(curr), false)\n\n            return selfDrop() || childDrop()\n        },\n        drop: (target: ?Object, event: DragEvent, inputs: Object) => {\n            let updatedModel = tree(model(), inputs.category).filter(e => inputs.selection.indexOf(e) < 0)\n            const adjustedTarget =\n                target ?\n                    target[inputs.category] && target[inputs.category] instanceof Array ?\n                        target :\n                        array(inputs.ancestors).last() :\n                    null\n            if(adjustedTarget)\n                adjustedTarget[inputs.category] = [ ...adjustedTarget[inputs.category], ...inputs.selection ]\n            else\n                updatedModel = [ ...updatedModel, ...inputs.selection ]\n            cb(updatedModel)\n        }\n    }),\n    // Plucks an item on drag\n    pluck: (model: void => Object[], cb: Object[] => void) => ({\n        draggable: true,\n        backup: [],\n        drag: (item: Object, event: DragEvent, inputs: Object) => {\n            bak = JSON.stringify(model())\n            event.dataTransfer && event.dataTransfer.setData(\"application/json\", JSON.stringify(item))\n            setTimeout(() => cb(tree(model(), inputs.category).filter(e => e !== item)), 20)\n        },\n        cancel: () => {\n            setTimeout(() => cb(JSON.parse(bak)), 20)\n        }\n    }),\n    // Pastes item(s) on drop\n    paste: (model: void => Object[], cb: Object[] => void) => ({\n        droppable: true,\n        drop: (target: Object, event: DragEvent, inputs: Object) => {\n            if(event.dataTransfer && event.dataTransfer.types.indexOf(\"application/json\") > -1) {\n                const data = JSON.parse(event.dataTransfer.getData(\"application/json\"))\n                let updatedModel = [...model()]\n                const adjustedTarget =\n                    target ?\n                        target[inputs.category] && target[inputs.category] instanceof Array ?\n                            target :\n                            array(inputs.ancestors).last() :\n                        null\n                if(adjustedTarget)\n                    adjustedTarget[inputs.category] = [ ...adjustedTarget[inputs.category], data ]\n                else\n                    updatedModel = [ ...updatedModel, data ]\n                cb(updatedModel)\n            }\n        }\n    })\n}\nlet bak = \"[]\"\n\n// Utils\n\nexport const utils = {\n    // Returns a list of local files/folders dropped\n    filesystem: (event: DragEvent) => {\n        const items = event.dataTransfer ? event.dataTransfer.items : null\n        if(items && items.length > 0 && items[0].kind === \"file\") {\n            const files = []\n            for(let i = 0; i < items.length; i++) {\n                /* eslint-disable */\n                const item = (items[i] : any).webkitGetAsEntry() || items[i].getAsFile()\n                /* eslint-enable */\n                if(item) {\n                    files.push(item)\n                }\n            }\n            return files\n        }\n        return null\n    }\n}\n\n// Internal use //\n\nexport const nodeEvents = {\n    onDragStart: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.stopPropagation()\n            this.inputs.get().dragndrop.onDrag(item, event, this.inputs.get())\n        }\n    },\n    onDragOver: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.preventDefault()\n            event.stopPropagation()\n\n            if(this.inputs.get().dragndrop.guard && this.inputs.get().dragndrop.guard(item, event, this.inputs.get())) {\n                event.dataTransfer && (event.dataTransfer.dropEffect = \"none\")\n                css.addClass(event.currentTarget, this.mixCss(\"nodrop\"))\n                return\n            }\n\n            css.addClass(event.currentTarget, this.mixCss(\"dragover\"))\n        }\n    },\n    onDragEnter: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.preventDefault()\n            event.stopPropagation()\n            // If dragging over an opener\n            if(item && (this.hasChildren(item) || this.isAsync(item)) && css.hasClass(event.target, this.mixCss(\"opener\"))) {\n                const newVal = this.state.get().unfolded.filter(i => i !== item)\n                newVal.push(item)\n                this.state.set({ unfolded: newVal })\n            }\n        }\n    },\n    onDragLeave: function(event: DragEvent) {\n        event.stopPropagation()\n        css.removeClass(event.currentTarget, this.mixCss(\"dragover\"))\n        css.removeClass(event.currentTarget, this.mixCss(\"nodrop\"))\n    },\n    onDrop: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.stopPropagation()\n            css.removeClass(event.currentTarget, this.mixCss(\"dragover\"))\n            css.removeClass(event.currentTarget, this.mixCss(\"nodrop\"))\n            this.inputs.get().dragndrop.onDrop(item, event, this.inputs.get())\n        }\n    },\n    onDragEnd: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.stopPropagation()\n            if(event.dataTransfer && event.dataTransfer.dropEffect === \"none\")\n                this.inputs.get().dragndrop.onCancel(item, event, this.inputs.get())\n        }\n    }\n}\n\nexport const wrapEvents = function() {\n    return {\n        ...this.inputs.get().dragndrop,\n        onDrag: (target: Object, event: DragEvent, inputs: Object) => {\n            if(!array(this.inputs.get().selection).contains(target)) {\n                this.onSelect(target, inputs.ancestors, inputs.neighbours)\n            }\n\n            this.outputs.onDrag && this.outputs.onDrag(target, event, inputs)\n        },\n        onDrop: (target: Object, event: DragEvent, inputs: Object) => {\n            event.preventDefault()\n            this.outputs.onDrop && this.outputs.onDrop(target, event, inputs)\n        },\n        onCancel: (target: Object, event: DragEvent, inputs: Object) => {\n            event.preventDefault()\n            if(event.dataTransfer && event.dataTransfer.dropEffect === \"none\")\n                this.outputs.onCancel && this.outputs.onCancel(target, event, inputs)\n        }\n    }\n}\n"]}