{"version":3,"sources":["../../src/core/dragndrop.js"],"names":["css","array","tree","dragndrop","selection","model","cb","draggable","droppable","drag","item","event","inputs","dataTransfer","setData","JSON","stringify","guard","target","types","indexOf","selfDrop","contains","childDrop","ancestors","reduce","prev","curr","drop","updatedModel","category","filter","e","adjustedTarget","Array","last","pluck","backup","bak","cancel","parse","paste","data","getData","utils","filesystem","items","length","kind","files","i","webkitGetAsEntry","getAsFile","push","tickDragover","nodeEvents","onDragStart","stopPropagation","get","onDrag","onDragOver","preventDefault","dropEffect","addClass","currentTarget","mixCss","requestAnimationFrame","onDragEnter","hasChildren","isAsync","hasClass","newVal","state","unfolded","set","onDragLeave","removeClass","onDrop","onDragEnd","onCancel","wrapEvents","onSelect","neighbours","outputs"],"mappings":"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","file":"dragndrop.js","sourcesContent":["// @flow\n\nimport { css, array, tree } from \"../tools\"\n\n// Drag and drop presets //\n\nexport const dragndrop = {\n    // Moves the selection //\n    selection: (model: void => Object[], cb: Object[] => void) => ({\n        draggable: true,\n        droppable: true,\n        drag: (item: Object, event: DragEvent, inputs: Object) => {\n            event.dataTransfer && event.dataTransfer.setData(\"application/json\", JSON.stringify(inputs.selection))\n        },\n        guard: (target: ?Object, event: DragEvent, inputs: Object) => {\n            // Other data types\n            if(event && event.dataTransfer && event.dataTransfer.types.indexOf(\"application/json\") < 0)\n                return false\n            // Prevent drop on self\n            const selfDrop = () => target && array(inputs.selection).contains(target)\n            // Prevent drop on child\n            const childDrop = () => inputs.ancestors &&\n                    inputs.ancestors.reduce((prev, curr) =>\n                        prev || array(inputs.selection).contains(curr), false)\n\n            return selfDrop() || childDrop()\n        },\n        drop: (target: ?Object, event: DragEvent, inputs: Object) => {\n            let updatedModel = tree(model(), inputs.category).filter(e => inputs.selection.indexOf(e) < 0)\n            const adjustedTarget =\n                target ?\n                    target[inputs.category] && target[inputs.category] instanceof Array ?\n                        target :\n                        array(inputs.ancestors).last() :\n                    null\n            if(adjustedTarget)\n                adjustedTarget[inputs.category] = [ ...adjustedTarget[inputs.category], ...inputs.selection ]\n            else\n                updatedModel = [ ...updatedModel, ...inputs.selection ]\n            cb(updatedModel)\n        }\n    }),\n    // Plucks an item on drag\n    pluck: (model: void => Object[], cb: Object[] => void) => ({\n        draggable: true,\n        backup: [],\n        drag: (item: Object, event: DragEvent, inputs: Object) => {\n            bak = JSON.stringify(model())\n            event.dataTransfer && event.dataTransfer.setData(\"application/json\", JSON.stringify(item))\n            cb(tree(model(), inputs.category).filter(e => e !== item))\n        },\n        cancel: () => {\n            cb(JSON.parse(bak))\n        }\n    }),\n    // Pastes item(s) on drop\n    paste: (model: void => Object[], cb: Object[] => void) => ({\n        droppable: true,\n        drop: (target: Object, event: DragEvent, inputs: Object) => {\n            if(event.dataTransfer && event.dataTransfer.types.indexOf(\"application/json\") > -1) {\n                const data = JSON.parse(event.dataTransfer.getData(\"application/json\"))\n                let updatedModel = [...model()]\n                const adjustedTarget =\n                    target ?\n                        target[inputs.category] && target[inputs.category] instanceof Array ?\n                            target :\n                            array(inputs.ancestors).last() :\n                        null\n                if(adjustedTarget)\n                    adjustedTarget[inputs.category] = [ ...adjustedTarget[inputs.category], data ]\n                else\n                    updatedModel = [ ...updatedModel, data ]\n                cb(updatedModel)\n            }\n        }\n    })\n}\nlet bak = \"[]\"\n\n// Utils\n\nexport const utils = {\n    // Returns a list of local files/folders dropped\n    filesystem: (event: DragEvent) => {\n        const items = event.dataTransfer ? event.dataTransfer.items : null\n        if(items && items.length > 0 && items[0].kind === \"file\") {\n            const files = []\n            for(let i = 0; i < items.length; i++) {\n                /* eslint-disable */\n                const item = (items[i] : any).webkitGetAsEntry() || items[i].getAsFile()\n                /* eslint-enable */\n                if(item) {\n                    files.push(item)\n                }\n            }\n            return files\n        }\n        return null\n    }\n}\n\n// Internal use //\n\nlet tickDragover = false\nexport const nodeEvents = {\n    onDragStart: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.stopPropagation()\n            this.inputs.get().dragndrop.onDrag(item, event, this.inputs.get())\n        }\n    },\n    onDragOver: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.preventDefault()\n            event.stopPropagation()\n\n            if(tickDragover) return\n            tickDragover = true\n\n            if(this.inputs.get().dragndrop.guard && this.inputs.get().dragndrop.guard(item, event, this.inputs.get())) {\n                event.dataTransfer && (event.dataTransfer.dropEffect = \"none\")\n                css.addClass(event.currentTarget, this.mixCss(\"nodrop\"))\n            } else {\n                css.addClass(event.currentTarget, this.mixCss(\"dragover\"))\n            }\n\n            requestAnimationFrame(() => { tickDragover = false })\n        }\n    },\n    onDragEnter: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.preventDefault()\n            event.stopPropagation()\n            // If dragging over an opener\n            if(item && (this.hasChildren(item) || this.isAsync(item)) && css.hasClass(event.target, this.mixCss(\"opener\"))) {\n                const newVal = this.state.get().unfolded.filter(i => i !== item)\n                newVal.push(item)\n                this.state.set({ unfolded: newVal })\n            }\n        }\n    },\n    onDragLeave: function(event: DragEvent) {\n        event.stopPropagation()\n        css.removeClass(event.currentTarget, this.mixCss(\"dragover\"))\n        css.removeClass(event.currentTarget, this.mixCss(\"nodrop\"))\n    },\n    onDrop: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.stopPropagation()\n            css.removeClass(event.currentTarget, this.mixCss(\"dragover\"))\n            css.removeClass(event.currentTarget, this.mixCss(\"nodrop\"))\n            this.inputs.get().dragndrop.onDrop(item, event, this.inputs.get())\n        }\n    },\n    onDragEnd: function(item: ?Object) {\n        return function(event: DragEvent) {\n            event.stopPropagation()\n            if(event.dataTransfer && event.dataTransfer.dropEffect === \"none\")\n                this.inputs.get().dragndrop.onCancel(item, event, this.inputs.get())\n        }\n    }\n}\n\nexport const wrapEvents = function() {\n    return {\n        ...this.inputs.get().dragndrop,\n        onDrag: (target: Object, event: DragEvent, inputs: Object) => {\n            if(!array(this.inputs.get().selection).contains(target)) {\n                this.onSelect(target, inputs.ancestors, inputs.neighbours)\n            }\n\n            this.outputs.onDrag && this.outputs.onDrag(target, event, inputs)\n        },\n        onDrop: (target: Object, event: DragEvent, inputs: Object) => {\n            event.preventDefault()\n            this.outputs.onDrop && this.outputs.onDrop(target, event, inputs)\n        },\n        onCancel: (target: Object, event: DragEvent, inputs: Object) => {\n            event.preventDefault()\n            if(event.dataTransfer && event.dataTransfer.dropEffect === \"none\")\n                this.outputs.onCancel && this.outputs.onCancel(target, event, inputs)\n        }\n    }\n}\n"]}