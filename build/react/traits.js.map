{"version":3,"sources":["../../src/react/traits.js"],"names":["React","CSSTransitionGroup","printer","combine","factories","Component","reduce","accu","factory","displayName","name","WrappedComponent","withLabels","defaultLabels","props","labels","withListener","eventType","propName","mountOn","autoMount","regulate","listening","ticking","callback","subscribe","cb","onEvent","event","window","requestAnimationFrame","bind","mount","document","addEventListener","unmount","removeEventListener","nextProps","listener","withTransition","key","render","transition","PureComponent","withDebugUpdates","print","_","monkeyPatch","ref","originalFunction","shouldComponentUpdate","nextState","nextContext","propsDiff","stateDiff","push","state","debug","toString","join"],"mappings":"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","file":"traits.js","sourcesContent":["// @flow\n\nimport React from \"react\"\nimport CSSTransitionGroup from \"react-transition-group/CSSTransitionGroup\"\nimport { printer } from \"../tools/printer\"\n\ntype FunctionComponent<P> = (props: P) => ?React.Element<any>\ntype ClassComponent<D, P, S> = Class<React.Component<D, P, S>>\n\ntype factory<P: Object> = (ClassComponent<void, P, *> | FunctionComponent<P>) => ClassComponent<void, P, *>\n// _ is a workaround to keep bypass generic type destruction\n/* eslint-disable */\ntype trait<_ = any> = Object => factory<*>\n/* eslint-enable */\n\n/* HOC reducer helper */\nexport const combine = (...factories : factory<*>[]) =>\n    <P: any>(Component: ClassComponent<void, P, *>) : ClassComponent<void, P, *> =>\n        factories.reduce((accu, factory) => factory(accu), Component)\n\nconst displayName = (name, WrappedComponent) =>\n    `${name}(${ WrappedComponent.displayName || WrappedComponent.name || \"Component\" })`\n\n/* Adds i18n support through customisable labels. */\nexport const withLabels : trait<> = (defaultLabels: Object) => Component =>\n        class extends React.Component {\n            static displayName = displayName(\"withLabels\", Component)\n            render() {\n                return <Component { ...this.props } labels={ { ...defaultLabels, ...this.props.labels } }></Component>\n            }\n        }\n\n/* Adds a configurable global listener. */\nexport const withListener : trait<> = ({\n        eventType = \"click\",\n        propName = \"listener\",\n        mountOn = null,\n        autoMount = false,\n        regulate = false } = {}) => Component =>\n    class extends React.Component<void, { listener: Object }, void> {\n\n        static displayName = displayName(\"withListener\", Component)\n        listening = false\n        ticking = false\n\n        /* Lifecycle */\n\n        constructor(props) {\n            super(props)\n            if(autoMount) this.mount()\n        }\n\n        componentWillUnmount() {\n            this.unmount()\n        }\n\n        componentWillReceiveProps(nextProps) {\n            if(mountOn) mountOn.bind(this)(nextProps) ? this.mount() : this.unmount()\n        }\n\n        /* Subscriptions */\n\n        callback = null\n        subscribe = (cb: (Event, ?(void => void)) => mixed) => {\n            this.callback = cb\n        }\n        onEvent = function(event: Event) {\n            if(this.callback) {\n                if(regulate) {\n                    if(!this.ticking) {\n                        const callback = this.callback\n                        window.requestAnimationFrame(() => callback(event, () => { this.ticking = false }))\n                    }\n                    this.ticking = true\n                } else\n                    this.callback(event)\n            }\n        }.bind(this)\n\n        /* Events */\n\n        mount = () => {\n            if(!this.listening) {\n                document.addEventListener(eventType, this.onEvent)\n                this.listening = true\n            }\n        }\n\n        unmount = () => {\n            if(this.listening) {\n                document.removeEventListener(eventType, this.onEvent)\n                this.listening = false\n            }\n        }\n\n        /* Rendering */\n\n        render() {\n            const listener = {\n                [propName]: {\n                    subscribe: this.subscribe,\n                    mount:     this.mount,\n                    unmount:   this.unmount\n                }\n            }\n            return <Component { ...listener } { ...this.props } ></Component>\n        }\n    }\n\n/* Adds transitions on component mount / unmount. */\nexport const withTransition : trait<> = ({ key }) => Component =>\n    class extends React.PureComponent {\n        static displayName = displayName(\"withTransition\", Component)\n        render = () =>\n            this.props.transition ?\n                <CSSTransitionGroup { ...this.props.transition }>\n                    <Component { ...this.props } key={ key(this.props) }></Component>\n                </CSSTransitionGroup> :\n            <Component { ...this.props }></Component>\n    }\n\n/* Add debug info for component updates */\nexport const withDebugUpdates : trait<> = ({ print = (_:string) : string => _ }) => Component =>\n    class extends React.Component {\n        static displayName = displayName(\"withDebugUpdates\", Component)\n        monkeyPatch = (ref: Object) => {\n            if(!ref) return\n            const originalFunction = ref.shouldComponentUpdate\n            ref.shouldComponentUpdate = function(nextProps, nextState, nextContext) {\n                const propsDiff = []\n                const stateDiff = []\n                for(const key in nextProps) {\n                    if(nextProps[key] !== ref.props[key])\n                        propsDiff.push(key)\n                }\n                for(const key in nextState) {\n                    if(nextState[key] !== ref.state[key])\n                        stateDiff.push(key)\n                }\n                /* eslint-disable */\n                printer.debug(`shouldComponentUpdate [${print(ref.toString())}]`, `State diff : ${stateDiff.join(\" \")}\\nProps diff : ${propsDiff.join(\" \")}`)\n                /* eslint-enable */\n                return originalFunction.bind(ref)(nextProps, nextState)\n            }\n        }\n\n        render = () =>\n            <Component {...this.props}\n                ref={ ref => this.monkeyPatch(ref) }>\n            </Component>\n\n    }\n"]}